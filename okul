#!/bin/bash

: '
 Dönüş Kodları
  0 : Başarılı
  1 : Hatalı sayıda arguman girişi
  2 : Girilen sınıf sayısı geçerli değil
  3 : Girilen cinsiyet bilgisi geçerli değil
  4 : Verilen dosya yok
  5 : Dosyada isimler benzersiz değil
'

write2stderr () {
  >&2 echo $@
}

list_students () {
  IFS=","
  while read name surname gender c_no
  do
    if [[ $2 =~ ^[0-9]+$ ]] # Arguman bir tamsayı ise
    then
      if [[ $c_no -eq $2 ]] # XXX: Yukarıdaki if ile birleştir?
      then
        echo $name $surname $gender
      fi
    elif [[ $2 =~ ^[eEkK]$ ]] # Arguman e,E,k,K den biri ise
    then
      if [[ $(grep -ixE $gender <<< $2) ]] # XXX: Yukarıdaki if ile birleştir?
      then
        echo $name $surname $c_no
      fi
    else
      echo $c_no $name $surname $gender
    fi
  done < $1
  return 0
}

is_file_unique() {
  if [[ $(cut -d "," -f 1 $1 | uniq -d) == "" ]] && [[ $(cut -d "," -f 2 $1 | uniq -d) == "" ]]
  then
    return 0
  else
    return 1
  fi
}

arguman_kontrol () {
  if [[ $# -gt 1 ]] # $# Fonksiyonun arguman sayısı (betiğin değil)
  then
    >&2 echo "HATA: (0..1) arguman bekleniyordu, $# arguman girildi.!"
    return 1
  elif [[ $# -eq 1 ]] # Arguman sayısı 1 ise
  then
    if [[ $1 =~ ^[0-9]+$ ]] # Arguman bir tamsayı ise
    then
      if [[ $1 -gt 0 ]] && [[ $1 -lt 5 ]] # Argumanın değeri 0-4 aralığında ise
      then
        return 0
      else
        write2stderr "Girilen sınıf 1-4 aralığında değil!"
        return 2 
      fi
    elif [[ $1 =~ ^[eEkK]$ ]] # Arguman e,E,k,K den biri ise
    then
      return 0
    else 
      write2stderr "Cinsiyet belirtmek için e, E, k, K karakterlerinden birini kullanın"
      return 3
    fi
  else
    return 0
  fi
}

main() {
  arguman_kontrol $@
  return_val=$?
  if [[ $return_val -eq 0 ]] # arguaman kontrol fonksiyonunun return değeri 0 ise
  then
    if [[ -e okul.csv ]]
    then
      is_file_unique okul.csv
      return_val=$?
      if [[ $return_val -eq 0 ]]
      then
        list_students okul.csv $@
      else
        return 5
      fi
    else
      return 4
    fi
  else
    return $return_val
  fi
}

main $@
